<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ソフトテニス 採点アプリ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            touch-action: manipulation; /* ダブルタップによるズームを無効化 */
        }
        /* ボタンの選択状態を無効化 */
        .btn {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        .blinking {
            animation: blink 1.5s linear infinite;
        }
        @keyframes blink {
            50% { opacity: 0.3; }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 max-w-4xl">
        <header class="text-center mb-4">
            <h1 class="text-2xl font-bold text-blue-600">ソフトテニス 採点票アプリ</h1>
        </header>

        <!-- 試合情報入力セクション -->
        <section id="match-info" class="bg-white p-4 rounded-lg shadow-md mb-4">
            <h2 class="text-lg font-bold mb-2 border-b pb-2">試合情報</h2>
            <div class="grid grid-cols-2 sm:grid-cols-5 gap-4 mb-4">
                <input type="text" id="tournament-name" placeholder="大会名" class="p-2 border rounded">
                <input type="text" id="entry-category" placeholder="エントリー区分" class="p-2 border rounded">
                <input type="text" id="round-name" placeholder="回戦" class="p-2 border rounded">
                <input type="text" id="court-number" placeholder="コート番号" class="p-2 border rounded">
                <select id="match-type" class="p-2 border rounded">
                    <option value="7">7ゲームマッチ</option>
                    <option value="5">5ゲームマッチ</option>
                    <option value="9">9ゲームマッチ</option>
                </select>
            </div>
            <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                <input type="text" id="main-referee" placeholder="正審" class="p-2 border rounded">
                <input type="text" id="sub-referee" placeholder="副審" class="p-2 border rounded">
                <input type="text" id="line-referee1" placeholder="線審" class="p-2 border rounded">
                <input type="text" id="line-referee2" placeholder="線審" class="p-2 border rounded">
            </div>
            <div class="grid grid-cols-2 gap-4 mt-4 text-center">
                <div class="bg-gray-100 p-2 rounded">
                    <span class="text-sm text-gray-500">開始時間</span>
                    <p id="start-time-display" class="font-bold">- - : - -</p>
                </div>
                <div class="bg-gray-100 p-2 rounded">
                    <span class="text-sm text-gray-500">終了時間</span>
                    <p id="end-time-display" class="font-bold">- - : - -</p>
                </div>
            </div>
        </section>
        
        <!-- 試合前設定セクション -->
        <section id="pre-match-setup" class="bg-white p-4 rounded-lg shadow-md mb-4">
            <h2 class="text-lg font-bold mb-4 text-center">試合前設定</h2>
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div class="space-y-2">
                    <input type="text" id="player-a-entry-no" placeholder="No." class="w-full p-2 border rounded text-center">
                    <input type="text" id="player-a-name-setup" placeholder="プレーヤー A 氏名" class="w-full p-2 border rounded text-center text-lg font-bold">
                    <input type="text" id="player-a-affiliation-setup" placeholder="所属" class="w-full p-2 border rounded text-center">
                </div>
                <div class="space-y-2">
                    <input type="text" id="player-b-entry-no" placeholder="No." class="w-full p-2 border rounded text-center">
                    <input type="text" id="player-b-name-setup" placeholder="プレーヤー B 氏名" class="w-full p-2 border rounded text-center text-lg font-bold">
                    <input type="text" id="player-b-affiliation-setup" placeholder="所属" class="w-full p-2 border rounded text-center">
                </div>
            </div>
            <p class="text-center text-gray-600 mb-4">トスに勝ったプレーヤーの選択を記録してください。</p>
            <div class="grid grid-cols-2 gap-4">
                <div class="text-center">
                    <h3 id="pre-match-player-a-display" class="font-bold text-xl mb-2 break-words">プレーヤー A</h3>
                    <div class="space-y-2">
                        <button data-player="A" data-choice="serve" class="pre-match-btn btn w-full bg-green-500 text-white p-3 rounded hover:bg-green-600">サーブを選択</button>
                        <button data-player="A" data-choice="receive" class="pre-match-btn btn w-full bg-blue-500 text-white p-3 rounded hover:bg-blue-600">レシーブを選択</button>
                        <button data-player="A" data-choice="side" class="pre-match-btn btn w-full bg-yellow-500 text-white p-3 rounded hover:bg-yellow-600">サイドを選択</button>
                    </div>
                </div>
                <div class="text-center">
                    <h3 id="pre-match-player-b-display" class="font-bold text-xl mb-2 break-words">プレーヤー B</h3>
                     <div class="space-y-2">
                        <button data-player="B" data-choice="serve" class="pre-match-btn btn w-full bg-green-500 text-white p-3 rounded hover:bg-green-600">サーブを選択</button>
                        <button data-player="B" data-choice="receive" class="pre-match-btn btn w-full bg-blue-500 text-white p-3 rounded hover:bg-blue-600">レシーブを選択</button>
                        <button data-player="B" data-choice="side" class="pre-match-btn btn w-full bg-yellow-500 text-white p-3 rounded hover:bg-yellow-600">サイドを選択</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- スコアボードセクション -->
        <section id="scoreboard" class="bg-white p-4 rounded-lg shadow-md hidden">
            <div class="grid grid-cols-2 gap-4 mb-4 text-center text-lg font-bold">
                <div id="scoreboard-name-a" class="p-2 bg-blue-50 text-blue-800 rounded break-words">プレーヤー A</div>
                <div id="scoreboard-name-b" class="p-2 bg-red-50 text-red-800 rounded break-words">プレーヤー B</div>
            </div>
            <div class="grid grid-cols-2 gap-4 mb-4 text-center">
                <div id="games-a" class="text-6xl font-bold text-blue-600">0</div>
                <div id="games-b" class="text-6xl font-bold text-red-600">0</div>
            </div>
            <div class="text-center text-gray-500 mb-4 -mt-4">GAMES</div>
            <div class="grid grid-cols-2 gap-4 mb-4 text-center">
                <div id="points-a" class="text-5xl font-semibold">0</div>
                <div id="points-b" class="text-5xl font-semibold">0</div>
            </div>
             <div class="text-center text-gray-500 mb-4 -mt-4">POINTS</div>
            <div class="grid grid-cols-2 gap-4 mb-2 text-center text-sm">
                <div><span id="server-a" class="font-bold bg-yellow-300 rounded px-2 py-1 hidden">SERVER</span></div>
                <div><span id="server-b" class="font-bold bg-yellow-300 rounded px-2 py-1 hidden">SERVER</span></div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <button id="score-a-btn" class="btn bg-blue-500 text-white font-bold py-8 rounded-lg text-2xl active:bg-blue-700">A ポイント</button>
                <button id="score-b-btn" class="btn bg-red-500 text-white font-bold py-8 rounded-lg text-2xl active:bg-red-700">B ポイント</button>
            </div>
        </section>

        <!-- 操作パネル -->
        <section id="controls" class="bg-white p-4 rounded-lg shadow-md mt-4 hidden">
            <h2 class="text-lg font-bold mb-2 border-b pb-2">操作パネル</h2>
            <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                <button id="undo-btn" class="btn bg-gray-500 text-white p-2 rounded hover:bg-gray-600">1つ戻す</button>
                <button id="reset-btn" class="btn bg-orange-500 text-white p-2 rounded hover:bg-orange-600">リセット</button>
                <button id="timeout-a-btn" class="btn bg-blue-200 text-blue-800 p-2 rounded hover:bg-blue-300">A タイム</button>
                <button id="timeout-b-btn" class="btn bg-red-200 text-red-800 p-2 rounded hover:bg-red-300">B タイム</button>
            </div>
            <div class="mt-4 border-t pt-4">
                <h3 class="text-md font-bold mb-2 text-center">警告</h3>
                <div class="grid grid-cols-2 gap-4">
                    <div class="text-center">
                        <p id="warning-player-a-name" class="mb-2 font-semibold">プレーヤー A</p>
                        <div class="flex justify-center space-x-2">
                            <button class="warning-btn btn bg-yellow-400 text-black w-10 h-10 rounded-full font-bold" data-player="A" data-type="Y1">Y</button>
                            <button class="warning-btn btn bg-yellow-400 text-black w-10 h-10 rounded-full font-bold" data-player="A" data-type="Y2">Y</button>
                            <button class="warning-btn btn bg-red-600 text-white w-10 h-10 rounded-full font-bold" data-player="A" data-type="R">R</button>
                        </div>
                    </div>
                    <div class="text-center">
                        <p id="warning-player-b-name" class="mb-2 font-semibold">プレーヤー B</p>
                        <div class="flex justify-center space-x-2">
                            <button class="warning-btn btn bg-yellow-400 text-black w-10 h-10 rounded-full font-bold" data-player="B" data-type="Y1">Y</button>
                            <button class="warning-btn btn bg-yellow-400 text-black w-10 h-10 rounded-full font-bold" data-player="B" data-type="Y2">Y</button>
                            <button class="warning-btn btn bg-red-600 text-white w-10 h-10 rounded-full font-bold" data-player="B" data-type="R">R</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 試合ログ -->
        <section id="match-log" class="bg-white p-4 rounded-lg shadow-md mt-4 hidden">
            <h2 class="text-lg font-bold mb-2 border-b pb-2">試合ログ</h2>
            <div id="log-area" class="text-sm text-gray-600 h-32 overflow-y-auto bg-gray-50 p-2 rounded">
                <p>試合を開始してください。</p>
            </div>
        </section>

        <!-- 試合結果表示 -->
        <div id="winner-display" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
            <div class="bg-white p-8 rounded-lg text-center shadow-2xl">
                <h2 class="text-3xl font-bold mb-4">試合終了！</h2>
                <p id="winner-text" class="text-2xl mb-6"></p>
                <button id="close-winner-btn" class="bg-blue-500 text-white px-6 py-2 rounded">閉じる</button>
            </div>
        </div>

    </div>

    <script>
        // DOM要素の取得
        const elements = {
            gamesA: document.getElementById('games-a'),
            gamesB: document.getElementById('games-b'),
            pointsA: document.getElementById('points-a'),
            pointsB: document.getElementById('points-b'),
            serverA: document.getElementById('server-a'),
            serverB: document.getElementById('server-b'),
            scoreABtn: document.getElementById('score-a-btn'),
            scoreBBtn: document.getElementById('score-b-btn'),
            undoBtn: document.getElementById('undo-btn'),
            resetBtn: document.getElementById('reset-btn'),
            timeoutABtn: document.getElementById('timeout-a-btn'),
            timeoutBBtn: document.getElementById('timeout-b-btn'),
            logArea: document.getElementById('log-area'),
            winnerDisplay: document.getElementById('winner-display'),
            winnerText: document.getElementById('winner-text'),
            closeWinnerBtn: document.getElementById('close-winner-btn'),
            matchType: document.getElementById('match-type'),
            preMatchSetup: document.getElementById('pre-match-setup'),
            scoreboard: document.getElementById('scoreboard'),
            controls: document.getElementById('controls'),
            matchLog: document.getElementById('match-log'),
            preMatchBtns: document.querySelectorAll('.pre-match-btn'),
            playerANameSetup: document.getElementById('player-a-name-setup'),
            playerAAffiliationSetup: document.getElementById('player-a-affiliation-setup'),
            playerBNameSetup: document.getElementById('player-b-name-setup'),
            playerBAffiliationSetup: document.getElementById('player-b-affiliation-setup'),
            preMatchPlayerADisplay: document.getElementById('pre-match-player-a-display'),
            preMatchPlayerBDisplay: document.getElementById('pre-match-player-b-display'),
            scoreboardNameA: document.getElementById('scoreboard-name-a'),
            scoreboardNameB: document.getElementById('scoreboard-name-b'),
            startTimeDisplay: document.getElementById('start-time-display'),
            endTimeDisplay: document.getElementById('end-time-display'),
            warningBtns: document.querySelectorAll('.warning-btn'),
            warningPlayerAName: document.getElementById('warning-player-a-name'),
            warningPlayerBName: document.getElementById('warning-player-b-name'),
        };

        // 試合状態の管理
        let state = {
            pointsA: 0,
            pointsB: 0,
            gamesA: 0,
            gamesB: 0,
            server: null,
            isFinalGame: false,
            matchOver: false,
            history: [],
            playerAName: 'プレーヤー A',
            playerBName: 'プレーヤー B',
            startTime: null,
            endTime: null,
            isDeuce: false,
        };

        const initialState = JSON.parse(JSON.stringify(state));

        const saveState = () => {
            state.history.push(JSON.parse(JSON.stringify(state)));
        };

        const formatTime = (date) => {
            if (!date) return '- - : - -';
            return date.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
        };

        const updateDisplay = () => {
            elements.gamesA.textContent = state.gamesA;
            elements.gamesB.textContent = state.gamesB;
            elements.startTimeDisplay.textContent = formatTime(state.startTime);
            elements.endTimeDisplay.textContent = formatTime(state.endTime);

            // ポイント表示ロジック
            if (state.isDeuce && !state.isFinalGame) {
                if (state.pointsA > state.pointsB) {
                    elements.pointsA.textContent = 'AD';
                    elements.pointsB.textContent = '-';
                } else if (state.pointsB > state.pointsA) {
                    elements.pointsA.textContent = '-';
                    elements.pointsB.textContent = 'AD';
                } else {
                    // デュースに戻った場合
                    elements.pointsA.textContent = state.pointsA;
                    elements.pointsB.textContent = state.pointsB;
                }
            } else {
                elements.pointsA.textContent = state.pointsA;
                elements.pointsB.textContent = state.pointsB;
            }
            
            elements.serverA.classList.toggle('hidden', state.server !== 'A' || state.matchOver);
            elements.serverB.classList.toggle('hidden', state.server !== 'B' || state.matchOver);
            elements.serverA.classList.remove('blinking');
            elements.serverB.classList.remove('blinking');
            if(state.isFinalGame && (state.pointsA + state.pointsB) % 2 === 1) {
                 if(state.server === 'A') elements.serverB.classList.add('blinking');
                 if(state.server === 'B') elements.serverA.classList.add('blinking');
            }

            elements.scoreABtn.disabled = state.matchOver;
            elements.scoreBBtn.disabled = state.matchOver;
        };

        const addLog = (message) => {
            const p = document.createElement('p');
            const timestamp = new Date().toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
            p.textContent = `[${timestamp}] ${message}`;
            elements.logArea.appendChild(p);
            elements.logArea.scrollTop = elements.logArea.scrollHeight;
        };
        
        // ▼▼▼ ここからが更新箇所です ▼▼▼
        const startMatch = (firstServer, choicePlayer, choice) => {
            const nameA = document.getElementById('player-a-name-setup').value || 'プレーヤー A';
            const affiliationA = document.getElementById('player-a-affiliation-setup').value;
            const entryNoA = document.getElementById('player-a-entry-no').value;
            state.playerAName = `${entryNoA ? 'No.' + entryNoA + ' ' : ''}${nameA}${affiliationA ? ' (' + affiliationA + ')' : ''}`;

            const nameB = document.getElementById('player-b-name-setup').value || 'プレーヤー B';
            const affiliationB = document.getElementById('player-b-affiliation-setup').value;
            const entryNoB = document.getElementById('player-b-entry-no').value;
            state.playerBName = `${entryNoB ? 'No.' + entryNoB + ' ' : ''}${nameB}${affiliationB ? ' (' + affiliationB + ')' : ''}`;
            
            elements.scoreboardNameA.textContent = state.playerAName;
            elements.scoreboardNameB.textContent = state.playerBName;
            elements.warningPlayerAName.textContent = nameA;
            elements.warningPlayerBName.textContent = nameB;

            state.server = firstServer;
            state.startTime = new Date();
            const choicePlayerName = state[`player${choicePlayer}Name`];
            
            let choiceText;
            if(choice === 'serve') {
                choiceText = 'サーブ';
            } else if (choice === 'receive') {
                choiceText = 'レシーブ';
            } else {
                choiceText = 'サイド';
            }

            addLog(`${choicePlayerName}が${choiceText}を選択しました。`);
            addLog(`試合開始 (サーバー: ${state[`player${firstServer}Name`]})`);

            elements.preMatchSetup.classList.add('hidden');
            elements.scoreboard.classList.remove('hidden');
            elements.controls.classList.remove('hidden');
            elements.matchLog.classList.remove('hidden');

            updateDisplay();
        };

        const addPoint = (player) => {
            if (state.matchOver) return;
            saveState();

            if (player === 'A') state.pointsA++;
            if (player === 'B') state.pointsB++;
            
            if (!state.isFinalGame && state.pointsA >= 3 && state.pointsB >= 3) {
                if (!state.isDeuce) {
                    state.isDeuce = true;
                    addLog("デュースに入りました。");
                }
                if (state.pointsA === state.pointsB) {
                    addLog("スコアがデュースに戻ります。");
                }
            }

            checkGameEnd();
            updateDisplay();
        };

        const checkGameEnd = () => {
            const pointsToWin = state.isFinalGame ? 7 : 4;
            const winMargin = 2;

            const aWins = state.pointsA >= pointsToWin && (state.pointsA - state.pointsB) >= winMargin;
            const bWins = state.pointsB >= pointsToWin && (state.pointsB - state.pointsA) >= winMargin;

            if (aWins || bWins) {
                const winner = aWins ? 'A' : 'B';
                const winnerName = state[`player${winner}Name`];
                const scoreLog = `${state.pointsA}-${state.pointsB}`;
                addLog(`ゲーム ${state.gamesA + state.gamesB + 1}: ${winnerName}が取得 (${scoreLog})`);

                if (winner === 'A') state.gamesA++;
                else state.gamesB++;
                
                state.pointsA = 0;
                state.pointsB = 0;
                state.isDeuce = false; 
                
                state.server = state.server === 'A' ? 'B' : 'A';

                checkMatchEnd();
            }
        };

        const checkMatchEnd = () => {
            const gamesToWin = Math.ceil(parseInt(elements.matchType.value) / 2);
            const finalGameTrigger = gamesToWin - 1;

            if (state.gamesA === gamesToWin || state.gamesB === gamesToWin) {
                state.matchOver = true;
                state.endTime = new Date();
                const winner = state.gamesA === gamesToWin ? 'A' : 'B';
                const winnerName = state[`player${winner}Name`];
                const result = `${winnerName}の勝利！ (${state.gamesA}-${state.gamesB})`;
                addLog(`試合終了: ${result}`);
                elements.winnerText.textContent = result;
                elements.winnerDisplay.classList.remove('hidden');
                updateDisplay();
            } else if (state.gamesA === finalGameTrigger && state.gamesB === finalGameTrigger) {
                state.isFinalGame = true;
                addLog("ファイナルゲーム開始！");
            }
        };

        const undo = () => {
            if (state.history.length > 0) {
                const prevState = state.history.pop();
                state = prevState;
                addLog("操作を1つ戻しました。");
                updateDisplay();
            } else {
                addLog("これ以上戻せません。");
            }
        };

        const resetMatch = () => {
            state = JSON.parse(JSON.stringify(initialState));
            
            elements.logArea.innerHTML = '<p>試合を開始してください。</p>';
            
            elements.preMatchSetup.classList.remove('hidden');
            elements.scoreboard.classList.add('hidden');
            elements.controls.classList.add('hidden');
            elements.matchLog.classList.add('hidden');
            elements.winnerDisplay.classList.add('hidden');

            document.getElementById('player-a-entry-no').value = '';
            document.getElementById('player-b-entry-no').value = '';
            elements.playerANameSetup.value = '';
            elements.playerAAffiliationSetup.value = '';
            elements.playerBNameSetup.value = '';
            elements.playerBAffiliationSetup.value = '';
            updatePreMatchDisplay();

            elements.warningBtns.forEach(btn => {
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
                btn.disabled = false;
            });

            updateDisplay();
            addLog("試合がリセットされました。");
        };

        elements.scoreABtn.addEventListener('click', () => addPoint('A'));
        elements.scoreBBtn.addEventListener('click', () => addPoint('B'));
        elements.undoBtn.addEventListener('click', undo);
        elements.resetBtn.addEventListener('click', resetMatch);
        elements.closeWinnerBtn.addEventListener('click', () => elements.winnerDisplay.classList.add('hidden'));

        elements.timeoutABtn.addEventListener('click', () => {
            addLog(`${state.playerAName}がタイムアウトを取りました。`);
        });
        elements.timeoutBBtn.addEventListener('click', () => {
            addLog(`${state.playerBName}がタイムアウトを取りました。`);
        });
        
        elements.preMatchBtns.forEach(button => {
            button.addEventListener('click', (e) => {
                const player = e.target.dataset.player;
                const choice = e.target.dataset.choice;
                let firstServer;
                if (choice === 'serve') {
                    firstServer = player;
                } else { // 'side' or 'receive'
                    firstServer = player === 'A' ? 'B' : 'A';
                }
                startMatch(firstServer, player, choice);
            });
        });
        // ▲▲▲ ここまでが更新箇所です ▲▲▲
        
        const updatePreMatchDisplay = () => {
            const nameA = elements.playerANameSetup.value || 'プレーヤー A';
            const affiliationA = elements.playerAAffiliationSetup.value;
            elements.preMatchPlayerADisplay.textContent = affiliationA ? `${nameA} (${affiliationA})` : nameA;

            const nameB = elements.playerBNameSetup.value || 'プレーヤー B';
            const affiliationB = elements.playerBAffiliationSetup.value;
            elements.preMatchPlayerBDisplay.textContent = affiliationB ? `${nameB} (${affiliationB})` : nameB;
        };

        elements.playerANameSetup.addEventListener('input', updatePreMatchDisplay);
        elements.playerAAffiliationSetup.addEventListener('input', updatePreMatchDisplay);
        elements.playerBNameSetup.addEventListener('input', updatePreMatchDisplay);
        elements.playerBAffiliationSetup.addEventListener('input', updatePreMatchDisplay);
        
        elements.warningBtns.forEach(button => {
            button.addEventListener('click', (e) => {
                const player = e.target.dataset.player;
                const type = e.target.dataset.type;
                const playerName = state[`player${player}Name`];
                addLog(`警告: ${playerName}に${type}が与えられました。`);
                e.target.classList.add('opacity-50', 'cursor-not-allowed');
                e.target.disabled = true;
            });
        });

    </script>
</body>
</html>
