<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ソフトテニス 採点アプリ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            touch-action: manipulation; /* ダブルタップによるズームを無効化 */
        }
        /* ボタンの選択状態を無効化 */
        .btn {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        .blinking {
            animation: blink 1.5s linear infinite;
        }
        @keyframes blink {
            50% { opacity: 0.3; }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 max-w-4xl">
        <header class="text-center mb-4">
            <h1 class="text-2xl font-bold text-blue-600">ソフトテニス 採点票アプリ</h1>
        </header>

        <!-- 試合情報入力セクション -->
        <section id="match-info" class="bg-white p-4 rounded-lg shadow-md mb-4">
            <h2 class="text-lg font-bold mb-2 border-b pb-2">試合情報</h2>
            <div class="grid grid-cols-2 sm:grid-cols-5 gap-4 mb-4">
                <input type="text" id="tournament-name" placeholder="大会名" class="p-2 border rounded">
                <input type="text" id="entry-category" placeholder="エントリー区分" class="p-2 border rounded">
                <input type="text" id="round-name" placeholder="回戦" class="p-2 border rounded">
                <input type="text" id="court-number" placeholder="コート番号" class="p-2 border rounded">
                <select id="match-type" class="p-2 border rounded">
                    <option value="7">7ゲームマッチ</option>
                    <option value="5">5ゲームマッチ</option>
                    <option value="9">9ゲームマッチ</option>
                </select>
            </div>
            <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                <input type="text" id="main-referee" placeholder="正審" class="p-2 border rounded">
                <input type="text" id="sub-referee" placeholder="副審" class="p-2 border rounded">
                <input type="text" id="line-referee1" placeholder="線審" class="p-2 border rounded">
                <input type="text" id="line-referee2" placeholder="線審" class="p-2 border rounded">
            </div>
            <div class="grid grid-cols-2 gap-4 mt-4 text-center">
                <div class="bg-gray-100 p-2 rounded">
                    <span class="text-sm text-gray-500">開始時間</span>
                    <p id="start-time-display" class="font-bold">- - : - -</p>
                </div>
                <div class="bg-gray-100 p-2 rounded">
                    <span class="text-sm text-gray-500">終了時間</span>
                    <p id="end-time-display" class="font-bold">- - : - -</p>
                </div>
            </div>
        </section>
        
        <!-- 試合前設定セクション -->
        <section id="pre-match-setup" class="bg-white p-4 rounded-lg shadow-md mb-4">
            <h2 class="text-lg font-bold mb-4 text-center">試合前設定</h2>
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div class="space-y-2">
                    <input type="text" id="player-a-entry-no" placeholder="No." class="w-full p-2 border rounded text-center">
                    <input type="text" id="player-a-name-setup" placeholder="プレーヤー A 氏名" class="w-full p-2 border rounded text-center text-lg font-bold">
                    <input type="text" id="player-a-affiliation-setup" placeholder="所属" class="w-full p-2 border rounded text-center">
                </div>
                <div class="space-y-2">
                    <input type="text" id="player-b-entry-no" placeholder="No." class="w-full p-2 border rounded text-center">
                    <input type="text" id="player-b-name-setup" placeholder="プレーヤー B 氏名" class="w-full p-2 border rounded text-center text-lg font-bold">
                    <input type="text" id="player-b-affiliation-setup" placeholder="所属" class="w-full p-2 border rounded text-center">
                </div>
            </div>
            <p class="text-center text-gray-600 mb-4">トスに勝ったプレーヤーの選択を記録してください。</p>
            <div class="grid grid-cols-2 gap-4">
                <div class="text-center">
                    <h3 id="pre-match-player-a-display" class="font-bold text-xl mb-2 break-words">プレーヤー A</h3>
                    <div class="space-y-2">
                        <button data-player="A" data-choice="serve" class="pre-match-btn btn w-full bg-green-500 text-white p-3 rounded hover:bg-green-600">サーブを選択</button>
                        <button data-player="A" data-choice="receive" class="pre-match-btn btn w-full bg-blue-500 text-white p-3 rounded hover:bg-blue-600">レシーブを選択</button>
                        <button data-player="A" data-choice="side" class="pre-match-btn btn w-full bg-yellow-500 text-white p-3 rounded hover:bg-yellow-600">サイドを選択</button>
                    </div>
                </div>
                <div class="text-center">
                    <h3 id="pre-match-player-b-display" class="font-bold text-xl mb-2 break-words">プレーヤー B</h3>
                     <div class="space-y-2">
                        <button data-player="B" data-choice="serve" class="pre-match-btn btn w-full bg-green-500 text-white p-3 rounded hover:bg-green-600">サーブを選択</button>
                        <button data-player="B" data-choice="receive" class="pre-match-btn btn w-full bg-blue-500 text-white p-3 rounded hover:bg-blue-600">レシーブを選択</button>
                        <button data-player="B" data-choice="side" class="pre-match-btn btn w-full bg-yellow-500 text-white p-3 rounded hover:bg-yellow-600">サイドを選択</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- スコアボードセクション -->
        <section id="scoreboard" class="bg-white p-4 rounded-lg shadow-md hidden">
            <div class="grid grid-cols-2 gap-4 mb-4 text-center text-lg font-bold">
                <div id="scoreboard-name-a" class="p-2 bg-blue-50 text-blue-800 rounded break-words">プレーヤー A</div>
                <div id="scoreboard-name-b" class="p-2 bg-red-50 text-red-800 rounded break-words">プレーヤー B</div>
            </div>
            <div class="grid grid-cols-2 gap-4 mb-4 text-center">
                <div id="games-a" class="text-6xl font-bold text-blue-600">0</div>
                <div id="games-b" class="text-6xl font-bold text-red-600">0</div>
            </div>
            <div class="text-center text-gray-500 mb-4 -mt-4">GAMES</div>
            <div class="grid grid-cols-2 gap-4 mb-4 text-center">
                <div id="points-a" class="text-5xl font-semibold">0</div>
                <div id="points-b" class="text-5xl font-semibold">0</div>
            </div>
             <div class="text-center text-gray-500 mb-4 -mt-4">POINTS</div>
            <div class="grid grid-cols-2 gap-4 mb-2 text-center text-sm">
                <div><span id="server-a" class="font-bold bg-yellow-300 rounded px-2 py-1 hidden">SERVER</span></div>
                <div><span id="server-b" class="font-bold bg-yellow-300 rounded px-2 py-1 hidden">SERVER</span></div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <button id="score-a-btn" class="btn bg-blue-500 text-white font-bold py-8 rounded-lg text-2xl active:bg-blue-700">A ポイント</button>
                <button id="score-b-btn" class="btn bg-red-500 text-white font-bold py-8 rounded-lg text-2xl active:bg-red-700">B ポイント</button>
            </div>
        </section>

        <!-- 操作パネル -->
        <section id="controls" class="bg-white p-4 rounded-lg shadow-md mt-4 hidden">
            <h2 class="text-lg font-bold mb-2 border-b pb-2">操作パネル</h2>
            <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                <button id="undo-btn" class="btn bg-gray-500 text-white p-2 rounded hover:bg-gray-600">1つ戻す</button>
                <button id="reset-btn" class="btn bg-orange-500 text-white p-2 rounded hover:bg-orange-600">リセット</button>
                <button id="timeout-a-btn" class="btn bg-blue-200 text-blue-800 p-2 rounded hover:bg-blue-300">A タイム</button>
                <button id="timeout-b-btn" class="btn bg-red-200 text-red-800 p-2 rounded hover:bg-red-300">B タイム</button>
            </div>
            <div class="mt-4 border-t pt-4">
                <h3 class="text-md font-bold mb-2 text-center">警告</h3>
                <div class="grid grid-cols-2 gap-4">
                    <div class="text-center">
                        <p id="warning-player-a-name" class="mb-2 font-semibold">プレーヤー A</p>
                        <div class="flex justify-center space-x-2">
                            <button class="warning-btn btn bg-yellow-400 text-black w-10 h-10 rounded-full font-bold" data-player="A" data-type="Y1">Y</button>
                            <button class="warning-btn btn bg-yellow-400 text-black w-10 h-10 rounded-full font-bold" data-player="A" data-type="Y2">Y</button>
                            <button class="warning-btn btn bg-red-600 text-white w-10 h-10 rounded-full font-bold" data-player="A" data-type="R">R</button>
                        </div>
                    </div>
                    <div class="text-center">
                        <p id="warning-player-b-name" class="mb-2 font-semibold">プレーヤー B</p>
                        <div class="flex justify-center space-x-2">
                            <button class="warning-btn btn bg-yellow-400 text-black w-10 h-10 rounded-full font-bold" data-player="B" data-type="Y1">Y</button>
                            <button class="warning-btn btn bg-yellow-400 text-black w-10 h-10 rounded-full font-bold" data-player="B" data-type="Y2">Y</button>
                            <button class="warning-btn btn bg-red-600 text-white w-10 h-10 rounded-full font-bold" data-player="B" data-type="R">R</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 試合ログ -->
        <section id="match-log" class="bg-white p-4 rounded-lg shadow-md mt-4 hidden">
            <h2 class="text-lg font-bold mb-2 border-b pb-2">試合ログ</h2>
            <div id="log-area" class="text-sm text-gray-600 h-32 overflow-y-auto bg-gray-50 p-2 rounded">
                <p>試合を開始してください。</p>
            </div>
        </section>
        
        <!-- 試合結果保存セクション -->
        <section id="result-save" class="bg-white p-4 rounded-lg shadow-md mt-4 hidden">
            <h2 class="text-lg font-bold mb-2 border-b pb-2">試合結果の保存</h2>
            <p class="text-sm text-gray-600 mb-4">試合結果をファイルとして保存、または印刷できます。</p>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <button id="save-txt-btn" class="btn bg-green-500 text-white p-3 rounded hover:bg-green-600">テキスト形式で保存 (.txt)</button>
                <button id="save-pdf-btn" class="btn bg-indigo-500 text-white p-3 rounded hover:bg-indigo-600">印刷 / PDF形式で表示</button>
            </div>
        </section>

        <!-- 試合結果表示 -->
        <div id="winner-display" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
            <div class="bg-white p-8 rounded-lg text-center shadow-2xl">
                <h2 class="text-3xl font-bold mb-4">試合終了！</h2>
                <p id="winner-text" class="text-2xl mb-6"></p>
                <button id="close-winner-btn" class="bg-blue-500 text-white px-6 py-2 rounded">閉じる</button>
            </div>
        </div>

    </div>

    <script>
        // DOM要素の取得
        const elements = {
            gamesA: document.getElementById('games-a'),
            gamesB: document.getElementById('games-b'),
            pointsA: document.getElementById('points-a'),
            pointsB: document.getElementById('points-b'),
            serverA: document.getElementById('server-a'),
            serverB: document.getElementById('server-b'),
            scoreABtn: document.getElementById('score-a-btn'),
            scoreBBtn: document.getElementById('score-b-btn'),
            undoBtn: document.getElementById('undo-btn'),
            resetBtn: document.getElementById('reset-btn'),
            timeoutABtn: document.getElementById('timeout-a-btn'),
            timeoutBBtn: document.getElementById('timeout-b-btn'),
            logArea: document.getElementById('log-area'),
            winnerDisplay: document.getElementById('winner-display'),
            winnerText: document.getElementById('winner-text'),
            closeWinnerBtn: document.getElementById('close-winner-btn'),
            matchType: document.getElementById('match-type'),
            preMatchSetup: document.getElementById('pre-match-setup'),
            scoreboard: document.getElementById('scoreboard'),
            controls: document.getElementById('controls'),
            matchLog: document.getElementById('match-log'),
            preMatchBtns: document.querySelectorAll('.pre-match-btn'),
            playerANameSetup: document.getElementById('player-a-name-setup'),
            playerAAffiliationSetup: document.getElementById('player-a-affiliation-setup'),
            playerBNameSetup: document.getElementById('player-b-name-setup'),
            playerBAffiliationSetup: document.getElementById('player-b-affiliation-setup'),
            preMatchPlayerADisplay: document.getElementById('pre-match-player-a-display'),
            preMatchPlayerBDisplay: document.getElementById('pre-match-player-b-display'),
            scoreboardNameA: document.getElementById('scoreboard-name-a'),
            scoreboardNameB: document.getElementById('scoreboard-name-b'),
            startTimeDisplay: document.getElementById('start-time-display'),
            endTimeDisplay: document.getElementById('end-time-display'),
            warningBtns: document.querySelectorAll('.warning-btn'),
            warningPlayerAName: document.getElementById('warning-player-a-name'),
            warningPlayerBName: document.getElementById('warning-player-b-name'),
            resultSave: document.getElementById('result-save'),
            saveTxtBtn: document.getElementById('save-txt-btn'),
            savePdfBtn: document.getElementById('save-pdf-btn'),
        };

        // ▼▼▼ ここからが修正箇所です ▼▼▼
        // 試合状態の管理
        let state = {}; // 初期化はresetMatchで行う

        // パフォーマンス改善のため、履歴はポイントの変動のみを記録する軽量なものに変更
        let pointHistory = [];

        const resetState = () => {
             state = {
                pointsA: 0,
                pointsB: 0,
                gamesA: 0,
                gamesB: 0,
                server: null,
                isFinalGame: false,
                matchOver: false,
                playerAName: 'プレーヤー A',
                playerBName: 'プレーヤー B',
                playerAEntryNo: '',
                playerBEntryNo: '',
                playerAAffiliation: '',
                playerBAffiliation: '',
                warnings: { A: [], B: [] },
                tossWinner: null,
                tossChoice: null,
                startTime: null,
                endTime: null,
                isDeuce: false,
            };
            pointHistory = [];
        }
        
        // 操作前の状態を記録
        const saveState = () => {
            pointHistory.push({
                pointsA: state.pointsA,
                pointsB: state.pointsB,
                gamesA: state.gamesA,
                gamesB: state.gamesB,
                server: state.server,
                isFinalGame: state.isFinalGame,
                isDeuce: state.isDeuce
            });
        };
        // ▲▲▲ ここまでが修正箇所です ▲▲▲

        const formatTime = (date) => {
            if (!date) return '- - : - -';
            return date.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
        };

        const updateDisplay = () => {
            elements.gamesA.textContent = state.gamesA;
            elements.gamesB.textContent = state.gamesB;
            elements.startTimeDisplay.textContent = formatTime(state.startTime);
            elements.endTimeDisplay.textContent = formatTime(state.endTime);

            // ポイント表示ロジック
            if (state.isDeuce && !state.isFinalGame) {
                if (state.pointsA > state.pointsB) {
                    elements.pointsA.textContent = 'AD';
                    elements.pointsB.textContent = '-';
                } else if (state.pointsB > state.pointsA) {
                    elements.pointsA.textContent = '-';
                    elements.pointsB.textContent = 'AD';
                } else {
                    elements.pointsA.textContent = state.pointsA;
                    elements.pointsB.textContent = state.pointsB;
                }
            } else {
                elements.pointsA.textContent = state.pointsA;
                elements.pointsB.textContent = state.pointsB;
            }
            
            elements.serverA.classList.toggle('hidden', state.server !== 'A' || state.matchOver);
            elements.serverB.classList.toggle('hidden', state.server !== 'B' || state.matchOver);
            elements.serverA.classList.remove('blinking');
            elements.serverB.classList.remove('blinking');
            if(state.isFinalGame && (state.pointsA + state.pointsB) % 2 === 1) {
                 if(state.server === 'A') elements.serverB.classList.add('blinking');
                 if(state.server === 'B') elements.serverA.classList.add('blinking');
            }

            elements.scoreABtn.disabled = state.matchOver;
            elements.scoreBBtn.disabled = state.matchOver;
        };

        const addLog = (message) => {
            const p = document.createElement('p');
            const timestamp = new Date().toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
            p.textContent = `[${timestamp}] ${message}`;
            elements.logArea.appendChild(p);
            elements.logArea.scrollTop = elements.logArea.scrollHeight;
        };
        
        const startMatch = (firstServer, choicePlayer, choice) => {
            resetState(); // 試合開始時に状態をリセット

            state.playerAName = document.getElementById('player-a-name-setup').value || 'プレーヤー A';
            state.playerAAffiliation = document.getElementById('player-a-affiliation-setup').value;
            state.playerAEntryNo = document.getElementById('player-a-entry-no').value;
            const playerADisplayName = `${state.playerAEntryNo ? 'No.' + state.playerAEntryNo + ' ' : ''}${state.playerAName}${state.playerAAffiliation ? ' (' + state.playerAAffiliation + ')' : ''}`;

            state.playerBName = document.getElementById('player-b-name-setup').value || 'プレーヤー B';
            state.playerBAffiliation = document.getElementById('player-b-affiliation-setup').value;
            state.playerBEntryNo = document.getElementById('player-b-entry-no').value;
            const playerBDisplayName = `${state.playerBEntryNo ? 'No.' + state.playerBEntryNo + ' ' : ''}${state.playerBName}${state.playerBAffiliation ? ' (' + state.playerBAffiliation + ')' : ''}`;
            
            elements.scoreboardNameA.textContent = playerADisplayName;
            elements.scoreboardNameB.textContent = playerBDisplayName;
            elements.warningPlayerAName.textContent = state.playerAName;
            elements.warningPlayerBName.textContent = state.playerBName;

            state.server = firstServer;
            state.startTime = new Date();
            state.tossWinner = choicePlayer;
            state.tossChoice = choice;

            const choicePlayerName = choicePlayer === 'A' ? playerADisplayName : playerBDisplayName;
            let choiceText;
            if(choice === 'serve') choiceText = 'サーブ';
            else if (choice === 'receive') choiceText = 'レシーブ';
            else choiceText = 'サイド';

            addLog(`${choicePlayerName}が${choiceText}を選択しました。`);
            addLog(`試合開始 (サーバー: ${firstServer === 'A' ? playerADisplayName : playerBDisplayName})`);

            elements.preMatchSetup.classList.add('hidden');
            elements.scoreboard.classList.remove('hidden');
            elements.controls.classList.remove('hidden');
            elements.matchLog.classList.remove('hidden');

            updateDisplay();
        };

        const addPoint = (player) => {
            if (state.matchOver) return;
            saveState(); // ポイントが入る直前の状態を保存

            if (player === 'A') state.pointsA++;
            if (player === 'B') state.pointsB++;
            
            if (!state.isFinalGame && state.pointsA >= 3 && state.pointsB >= 3) {
                if (!state.isDeuce) {
                    state.isDeuce = true;
                    addLog("デュースに入りました。");
                }
                if (state.pointsA === state.pointsB) {
                    addLog("スコアがデュースに戻ります。");
                }
            }

            checkGameEnd();
            updateDisplay();
        };

        const checkGameEnd = () => {
            const pointsToWin = state.isFinalGame ? 7 : 4;
            const winMargin = 2;

            const aWins = state.pointsA >= pointsToWin && (state.pointsA - state.pointsB) >= winMargin;
            const bWins = state.pointsB >= pointsToWin && (state.pointsB - state.pointsA) >= winMargin;

            if (aWins || bWins) {
                const winner = aWins ? 'A' : 'B';
                const winnerName = winner === 'A' ? state.playerAName : state.playerBName;
                const scoreLog = `${state.pointsA}-${state.pointsB}`;
                addLog(`ゲーム ${state.gamesA + state.gamesB + 1}: ${winnerName}が取得 (${scoreLog})`);

                if (winner === 'A') state.gamesA++;
                else state.gamesB++;
                
                state.pointsA = 0;
                state.pointsB = 0;
                state.isDeuce = false; 
                
                state.server = state.server === 'A' ? 'B' : 'A';

                checkMatchEnd();
            }
        };

        const checkMatchEnd = () => {
            const gamesToWin = Math.ceil(parseInt(elements.matchType.value) / 2);
            const finalGameTrigger = gamesToWin - 1;

            if (state.gamesA === gamesToWin || state.gamesB === gamesToWin) {
                state.matchOver = true;
                state.endTime = new Date();
                const winner = state.gamesA === gamesToWin ? 'A' : 'B';
                const winnerName = winner === 'A' ? state.playerAName : state.playerBName;
                const result = `${winnerName}の勝利！ (${state.gamesA}-${state.gamesB})`;
                addLog(`試合終了: ${result}`);
                elements.winnerText.textContent = result;
                elements.winnerDisplay.classList.remove('hidden');
                elements.resultSave.classList.remove('hidden');
                updateDisplay();
            } else if (state.gamesA === finalGameTrigger && state.gamesB === finalGameTrigger) {
                state.isFinalGame = true;
                addLog("ファイナルゲーム開始！");
            }
        };

        // ▼▼▼ ここからが修正箇所です ▼▼▼
        const undo = () => {
            if (pointHistory.length > 0) {
                const prevState = pointHistory.pop(); // 最後の履歴を取り出す
                // stateの各プロパティを履歴の状態に戻す
                state.pointsA = prevState.pointsA;
                state.pointsB = prevState.pointsB;
                state.gamesA = prevState.gamesA;
                state.gamesB = prevState.gamesB;
                state.server = prevState.server;
                state.isFinalGame = prevState.isFinalGame;
                state.isDeuce = prevState.isDeuce;
                state.matchOver = false; // 試合が終わっていても戻せるように
                
                addLog("操作を1つ戻しました。");
                updateDisplay();
                 // undo後に試合結果表示などを非表示にする
                elements.winnerDisplay.classList.add('hidden');
                elements.resultSave.classList.add('hidden');

            } else {
                addLog("これ以上戻せません。");
            }
        };
        // ▲▲▲ ここまでが修正箇所です ▲▲▲

        const resetMatch = () => {
            resetState();
            
            elements.logArea.innerHTML = '<p>試合を開始してください。</p>';
            
            elements.preMatchSetup.classList.remove('hidden');
            elements.scoreboard.classList.add('hidden');
            elements.controls.classList.add('hidden');
            elements.matchLog.classList.add('hidden');
            elements.winnerDisplay.classList.add('hidden');
            elements.resultSave.classList.add('hidden');

            document.getElementById('player-a-entry-no').value = '';
            document.getElementById('player-b-entry-no').value = '';
            elements.playerANameSetup.value = '';
            elements.playerAAffiliationSetup.value = '';
            elements.playerBNameSetup.value = '';
            elements.playerBAffiliationSetup.value = '';
            updatePreMatchDisplay();

            elements.warningBtns.forEach(btn => {
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
                btn.disabled = false;
            });

            updateDisplay();
        };
        
        document.addEventListener('DOMContentLoaded', resetMatch);

        elements.scoreABtn.addEventListener('click', () => addPoint('A'));
        elements.scoreBBtn.addEventListener('click', () => addPoint('B'));
        elements.undoBtn.addEventListener('click', undo);
        elements.resetBtn.addEventListener('click', resetMatch);
        elements.closeWinnerBtn.addEventListener('click', () => elements.winnerDisplay.classList.add('hidden'));

        elements.timeoutABtn.addEventListener('click', () => {
            addLog(`${state.playerAName}がタイムアウトを取りました。`);
        });
        elements.timeoutBBtn.addEventListener('click', () => {
            addLog(`${state.playerBName}がタイムアウトを取りました。`);
        });
        
        elements.preMatchBtns.forEach(button => {
            button.addEventListener('click', (e) => {
                const player = e.target.dataset.player;
                const choice = e.target.dataset.choice;
                let firstServer;
                if (choice === 'serve') {
                    firstServer = player;
                } else { // 'side' or 'receive'
                    firstServer = player === 'A' ? 'B' : 'A';
                }
                startMatch(firstServer, player, choice);
            });
        });
        
        const updatePreMatchDisplay = () => {
            const nameA = elements.playerANameSetup.value || 'プレーヤー A';
            const affiliationA = elements.playerAAffiliationSetup.value;
            elements.preMatchPlayerADisplay.textContent = affiliationA ? `${nameA} (${affiliationA})` : nameA;

            const nameB = elements.playerBNameSetup.value || 'プレーヤー B';
            const affiliationB = elements.playerBAffiliationSetup.value;
            elements.preMatchPlayerBDisplay.textContent = affiliationB ? `${nameB} (${affiliationB})` : nameB;
        };

        elements.playerANameSetup.addEventListener('input', updatePreMatchDisplay);
        elements.playerAAffiliationSetup.addEventListener('input', updatePreMatchDisplay);
        elements.playerBNameSetup.addEventListener('input', updatePreMatchDisplay);
        elements.playerBAffiliationSetup.addEventListener('input', updatePreMatchDisplay);
        
        elements.warningBtns.forEach(button => {
            button.addEventListener('click', (e) => {
                const player = e.target.dataset.player;
                const type = e.target.dataset.type;
                state.warnings[player].push(type);
                const playerName = player === 'A' ? state.playerAName : state.playerBName;
                addLog(`警告: ${playerName}に${type}が与えられました。`);
                e.target.classList.add('opacity-50', 'cursor-not-allowed');
                e.target.disabled = true;
            });
        });

        // ▼▼▼ ここからが修正箇所です ▼▼▼
        // 記録処理のためのヘルパー関数
        const getMatchData = () => {
            const games = [];
            let currentGamePoints = [];
            let lastGamesA = 0;
            let lastGamesB = 0;
            
            const fullHistory = [...pointHistory, state]; // 現在の最終スコアも履歴に加える

            fullHistory.forEach((hist, index) => {
                 const gameChanged = hist.gamesA !== lastGamesA || hist.gamesB !== lastGamesB;

                 if (!gameChanged) {
                    currentGamePoints.push({ a: hist.pointsA, b: hist.pointsB });
                 } else {
                    if (index > 0) { // 最初のポイントではない場合
                        games.push({
                            gameNumber: lastGamesA + lastGamesB + 1,
                            points: currentGamePoints,
                            winner: hist.gamesA > lastGamesA ? 'A' : 'B',
                        });
                    }
                    currentGamePoints = [{ a: hist.pointsA, b: hist.pointsB }];
                    lastGamesA = hist.gamesA;
                    lastGamesB = hist.gamesB;
                 }
            });

            // 最後のゲームを追加
            if (currentGamePoints.length > 0) {
                 games.push({
                    gameNumber: lastGamesA + lastGamesB + 1,
                    points: currentGamePoints,
                    winner: state.gamesA > lastGamesA ? 'A' : 'B'
                });
            }

            return {
                tournamentName: document.getElementById('tournament-name').value,
                entryCategory: document.getElementById('entry-category').value,
                roundName: document.getElementById('round-name').value,
                courtNumber: document.getElementById('court-number').value,
                mainReferee: document.getElementById('main-referee').value,
                subReferee: document.getElementById('sub-referee').value,
                lineReferee1: document.getElementById('line-referee1').value,
                lineReferee2: document.getElementById('line-referee2').value,
                startTime: formatTime(state.startTime),
                endTime: formatTime(state.endTime),
                playerA: { name: state.playerAName, no: state.playerAEntryNo, affiliation: state.playerAAffiliation },
                playerB: { name: state.playerBName, no: state.playerBEntryNo, affiliation: state.playerBAffiliation },
                finalGameScore: { a: state.gamesA, b: state.gamesB },
                winner: state.gamesA > state.gamesB ? 'A' : 'B',
                games: games,
                warnings: state.warnings,
            };
        };
        // ▲▲▲ ここまでが修正箇所です ▲▲▲

        // テキスト形式で保存
        const generateTextRecord = () => {
            const data = getMatchData();
            let text = 'ソフトテニス試合結果\n';
            text += '====================================\n';
            text += `大会名: ${data.tournamentName}\n`;
            text += `区分: ${data.entryCategory} | ${data.roundName} | コート: ${data.courtNumber}\n`;
            text += `時間: ${data.startTime} - ${data.endTime}\n`;
            text += `審判: (正) ${data.mainReferee} (副) ${data.subReferee} (線) ${data.lineReferee1}, ${data.lineReferee2}\n`;
            text += '------------------------------------\n';
            text += `(A) ${data.playerA.no ? 'No.' + data.playerA.no + ' ' : ''}${data.playerA.name}${data.playerA.affiliation ? ' (' + data.playerA.affiliation + ')' : ''}\n`;
            text += `(B) ${data.playerB.no ? 'No.' + data.playerB.no + ' ' : ''}${data.playerB.name}${data.playerB.affiliation ? ' (' + data.playerB.affiliation + ')' : ''}\n`;
            text += `最終スコア: ${data.finalGameScore.a} - ${data.finalGameScore.b}\n`;
            text += `勝者: ${data.winner === 'A' ? data.playerA.name : data.playerB.name}\n`;
            text += '====================================\n\n';
            text += 'ポイント履歴:\n';

            data.games.forEach(game => {
                text += `\n--- 第${game.gameNumber}ゲーム (取得: ${game.winner === 'A' ? data.playerA.name : data.playerB.name}) ---\n`;
                let pointLog = '';
                game.points.forEach(p => {
                    pointLog += `${p.a}-${p.b}, `;
                });
                text += pointLog.slice(0, -2) + '\n';
            });

            const blob = new Blob([text], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `試合結果_${data.playerA.name}_vs_${data.playerB.name}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        };

        // 印刷/PDF形式で表示
        const generatePrintableRecord = () => {
            const data = getMatchData();
            const maxGames = parseInt(elements.matchType.value);
            
            let gameHeaders = '';
            for (let i = 1; i <= maxGames; i++) {
                gameHeaders += `<th class="border p-1 text-center w-12">${i}</th>`;
            }

            let srRowA = '';
            let srRowB = '';
            let pointRowsA = '';
            let pointRowsB = '';
            
            const initialServer = pointHistory.length > 0 ? pointHistory[0].server : state.server;

            for (let i = 0; i < maxGames; i++) {
                const game = data.games.find(g => g.gameNumber === i + 1);
                
                let server = '';
                if(initialServer){
                    server = (i % 2 === 0) ? initialServer : (initialServer === 'A' ? 'B' : 'A');
                }

                srRowA += `<td class="border p-1 text-center h-8">${server === 'A' ? '●' : ''}</td>`;
                srRowB += `<td class="border p-1 text-center h-8">${server === 'B' ? '●' : ''}</td>`;
                
                let pointsA = '';
                let pointsB = '';
                if(game) {
                    let isFinalGameInHist = (i + 1) === (gamesToWin - 1) * 2 + 1;

                    game.points.forEach(p => {
                        let pa = p.a;
                        let pb = p.b;
                         if ( p.a >= 3 && p.b >= 3 && !isFinalGameInHist) {
                            if (p.a > p.b) { pa = 'AD'; pb = '-'; }
                            else if (p.b > p.a) { pa = '-'; pb = 'AD'; }
                        }
                        pointsA += `<div class="border-b h-6 flex items-center justify-center">${pa}</div>`;
                        pointsB += `<div class="border-b h-6 flex items-center justify-center">${pb}</div>`;
                    });
                }
                pointRowsA += `<td class="border p-0 align-top">${pointsA}</td>`;
                pointRowsB += `<td class="border p-0 align-top">${pointsB}</td>`;
            }

            const html = `
                <html>
                <head>
                    <title>試合結果: ${data.playerA.name} vs ${data.playerB.name}</title>
                    <script src="https://cdn.tailwindcss.com"><\/script>
                    <style> @media print { @page { size: A4 landscape; } body { -webkit-print-color-adjust: exact; } } </style>
                </head>
                <body class="p-4">
                    <h1 class="text-2xl font-bold text-center mb-4">ダブルス・シングルス採点票</h1>
                    <div class="grid grid-cols-3 gap-4 mb-4 text-sm">
                        <div>
                            <p><strong>大会名:</strong> ${data.tournamentName}</p>
                            <p><strong>区分:</strong> ${data.entryCategory}</p>
                            <p><strong>回戦:</strong> ${data.roundName}</p>
                            <p><strong>コート:</strong> ${data.courtNumber}</p>
                        </div>
                        <div class="text-center">
                            <p><strong>正審:</strong> ${data.mainReferee}</p>
                            <p><strong>副審:</strong> ${data.subReferee}</p>
                            <p><strong>線審:</strong> ${data.lineReferee1}, ${data.lineReferee2}</p>
                        </div>
                        <div class="text-right">
                            <p><strong>開始:</strong> ${data.startTime}</p>
                            <p><strong>終了:</strong> ${data.endTime}</p>
                            <p><strong>試合時間:</strong> ${state.startTime && state.endTime ? Math.round((state.endTime - state.startTime) / 60000) + '分' : '-'}</p>
                        </div>
                    </div>

                    <table class="w-full border-collapse text-sm">
                        <thead>
                            <tr>
                                <th class="border p-1">No.</th>
                                <th class="border p-1">プレーヤー</th>
                                <th class="border p-1">所属</th>
                                ${gameHeaders}
                                <th class="border p-1 text-center">計</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="border p-1 text-center" rowspan="2">${data.playerA.no}</td>
                                <td class="border p-1" rowspan="2">${data.playerA.name}</td>
                                <td class="border p-1" rowspan="2">${data.playerA.affiliation}</td>
                                ${pointRowsA}
                                <td class="border p-1 text-center text-2xl font-bold" rowspan="4">${data.finalGameScore.a}</td>
                            </tr>
                             <tr>
                                ${srRowA}
                            </tr>
                            <tr>
                                <td class="border p-1 text-center" rowspan="2">${data.playerB.no}</td>
                                <td class="border p-1" rowspan="2">${data.playerB.name}</td>
                                <td class="border p-1" rowspan="2">${data.playerB.affiliation}</td>
                                ${pointRowsB}
                                <td class="border p-1 text-center text-2xl font-bold" rowspan="4">${data.finalGameScore.b}</td>
                            </tr>
                             <tr>
                                ${srRowB}
                            </tr>
                        </tbody>
                    </table>
                    <div class="mt-4 text-center">
                      <p>勝者: <strong>${data.winner === 'A' ? data.playerA.name : data.playerB.name}</strong></p>
                    </div>
                </body>
                </html>
            `;

            const printWindow = window.open('', '_blank');
            printWindow.document.write(html);
            printWindow.document.close();
            printWindow.focus();
            setTimeout(() => { printWindow.print(); }, 500);
        };
        
        elements.saveTxtBtn.addEventListener('click', generateTextRecord);
        elements.savePdfBtn.addEventListener('click', generatePrintableRecord);

    </script>
</body>
</html>

